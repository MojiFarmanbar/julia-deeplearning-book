{
  "hash": "bb693c8f3e9c272f755bd1549e3ba068",
  "result": {
    "markdown": "# Chapter 4: Under the Hood: Training a Digit Classifier\n\n\n\n## Calculating Gradients\n\n### Using [`Flux.jl`](https://fluxml.ai/Flux.jl/stable/models/basics/)\n\nTaking gradients in `Flux.jl` is as simple as calling `gradient` on a function. For example, to take the gradient of `f(x) = x^2` at `x = 2`, we can do the following:\n\n::: {#34768a0e .cell execution_count=2}\n``` {.julia .cell-code}\nf(x) = x^2\ndf(x) = gradient(f, x)[1]\ndf(2)\n```\n\n::: {.cell-output .cell-output-display execution_count=3}\n```\n4.0\n```\n:::\n:::\n\n\nBelow we implement and visualise gradient descent from scratch in Julia. \n\n::: {#c0fbb8be .cell execution_count=3}\n``` {.julia .cell-code}\nxmax = 10\nn = 100\nplt = plot(\n    range(-xmax, xmax, length=n), f;\n    label=\"f(x)\", lw=5, xlim=1.5 .* [-xmax, xmax], \n    xlab=\"Parameter\", ylab=\"Loss\",legend=false\n)\n\nnsteps = 10\nlrs = [0.05, 0.3, 0.975, 1.025]\ndescend(x;lr=0.1) = x - lr * df(x)\nx = [-0.75xmax]       \nx = repeat(x,length(lrs),1)                             # repeat x for each learning rate\nplts = [deepcopy(plt) for i in 1:length(lrs)]           # repeat plt for each learning rate\nanim = @animate for j in 1:nsteps\n    global x = hcat(x, zeros(size(x,1)))                # add column of zeros to x\n    for (i, lr) in enumerate(lrs)\n        _plt = plot(plts[i], title=\"lr = $lr\", ylims=(0,f(xmax)), legend=false)\n        scatter!([x[i,j]], [f(x[i,j])]; label=nothing, ms=5, c=:red)    # plot current point\n        x[i,j+1] = descend(x[i,j]; lr=lr)                               # descend\n        Δx = x[i,j+1] - x[i,j]\n        Δy = f(x[i,j+1]) - f(x[i,j])\n        quiver!([x[i,j]],[f(x[i,j])],quiver=([Δx],[0]),c=:red)          # horizontal arrow\n        quiver!([x[i,j+1]],[f(x[i,j])],quiver=([0],[Δy]),c=:red)        # vertical arrow\n        plts[i] = _plt\n    end\n    plot(\n        plts..., legend=false,\n        plot_title=\"Step $j\", margin = 5mm,\n        dpi=300,\n    )\nend\ngif(anim, joinpath(www_path, \"c4_gd.gif\"), fps=0.5)\n```\n:::\n\n\n![Gradient descent for different learning rates](../www/c4_gd.gif){#fig-gd width=\"100%\"}\n\n## Training a Digit Classifier\n\nThe MNIST dataset can be loaded in Julia as follows:\n\n::: {#4b90bcf9 .cell execution_count=4}\n``` {.julia .cell-code}\n# Data\nX, y = MLDatasets.MNIST(:train)[:]\ny_enc = Flux.onehotbatch(y, 0:9)\nXtest, ytest = MLDatasets.MNIST(:test)[:]\nytest_enc = onehotbatch(ytest, 0:9)\nmosaic(map(i -> convert2image(MNIST, X[:,:,i]), rand(1:60000,100)), ncol=10)\n```\n\n::: {.cell-output .cell-output-display execution_count=4}\n```{=html}\n<img src=\"data:image/png;base64,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\">\n```\n:::\n:::\n\n\nWe can preprocess the data as follows:\n\n::: {#55edfadb .cell execution_count=5}\n``` {.julia .cell-code}\ni_train, i_val = [], []\nfor (k,v) in group_indices(y)\n    _i_train, _i_val = splitobs(v, at=0.7)\n    push!(i_train, _i_train...)\n    push!(i_val, _i_val...)\nend\nXtrain, ytrain = X[:,:,i_train], y_enc[:,i_train]\nXval, yval = X[:,:,i_val], y_enc[:,i_val]\n```\n\n::: {.cell-output .cell-output-display execution_count=5}\n```\n([0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0;;; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0;;; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0;;; … ;;; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0;;; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0;;; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0], Bool[0 0 … 0 0; 0 0 … 1 1; … ; 0 0 … 0 0; 0 0 … 0 0])\n```\n:::\n:::\n\n\nNext, we define a data loader:\n\n::: {#fcaa5808 .cell execution_count=6}\n``` {.julia .cell-code}\nbatchsize = 128\ntrain_set = DataLoader((Xtrain, ytrain), batchsize=batchsize, shuffle=true)\nval_set = DataLoader((Xval, yval), batchsize=batchsize)\n```\n\n::: {.cell-output .cell-output-display execution_count=6}\n```\n141-element DataLoader(::Tuple{Array{Float32, 3}, OneHotMatrix{UInt32, Vector{UInt32}}}, batchsize=128)\n  with first element:\n  (28×28×128 Array{Float32, 3}, 10×128 OneHotMatrix(::Vector{UInt32}) with eltype Bool,)\n```\n:::\n:::\n\n\nWe can now define a model, based on how we preprocessed the data:\n\n::: {#42bf1972 .cell execution_count=7}\n``` {.julia .cell-code}\nmodel = Chain(\n    Flux.flatten,\n    Dense(28^2, 32, relu),\n    Dense(32, 10),\n    softmax\n)\n```\n\n::: {.cell-output .cell-output-display execution_count=7}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre>Chain(\n  Flux.flatten,\n  Dense(784 =&gt; 32, relu),               <span class=\"ansi-bright-black-fg\"># 25_120 parameters</span>\n  Dense(32 =&gt; 10),                      <span class=\"ansi-bright-black-fg\"># 330 parameters</span>\n  NNlib.softmax,\n) <span class=\"ansi-bright-black-fg\">                  # Total: 4 arrays, </span>25_450 parameters, 99.664 KiB.</pre>\n```\n:::\n\n:::\n:::\n\n\nFinally, what's left to do is to define a loss function and an optimiser:\n\n::: {#a036969c .cell execution_count=8}\n``` {.julia .cell-code}\nloss(y_hat, y) = Flux.Losses.crossentropy(y_hat, y)\nopt_state = Flux.setup(Adam(),model)\n```\n:::\n\n\nBefore we start training, we define some helper functions:\n\n::: {#7532a49f .cell execution_count=9}\n``` {.julia .cell-code}\n# Callbacks:\nfunction accuracy(model, data::DataLoader)\n    acc = 0\n    for (x,y) in data\n        acc += sum(onecold(model(x)) .== onecold(y)) / size(y,2)\n    end\n    return acc / length(data)\nend\n\nfunction avg_loss(model, data::DataLoader)\n    _loss = 0\n    for (x,y) in data\n        _loss += loss(model(x), y)[1]\n    end\n    return _loss / length(data)\nend\n```\n:::\n\n\nAs a very last step, we set up our training logs:\n\n::: {#78b6f2b0 .cell execution_count=10}\n``` {.julia .cell-code}\n# Final setup:\nnepochs = 100\nlog = []\nacc_train, acc_val = accuracy(model, train_set), accuracy(model, val_set)\nloss_train, loss_val = avg_loss(model, train_set), avg_loss(model, val_set)\nresults = Dict(\n    :epoch => 0,\n    :acc_train => acc_train,\n    :acc_val => acc_val,\n    :loss_train => loss_train,\n    :loss_val => loss_val\n)\npush!(log, results)\n```\n:::\n\n\nBelow we finally train our model:\n\n::: {#441f9091 .cell execution_count=11}\n``` {.julia .cell-code}\n# Training loop:\nfor epoch in 1:nepochs\n\n    for (i, data) in enumerate(train_set)\n\n        # Extract data:\n        input, label = data\n\n        # Compute loss and gradient:\n        val, grads = Flux.withgradient(model) do m\n            result = m(input)\n            loss(result, label)\n        end\n\n        # Detect loss of Inf or NaN. Print a warning, and then skip update!\n        if !isfinite(val)\n            @warn \"loss is $val on item $i\" epoch\n            continue\n        end\n\n        Flux.update!(opt_state, model, grads[1])\n\n    end\n\n    # Monitor progress:\n    acc_train, acc_val = accuracy(model, train_set), accuracy(model, val_set)\n    loss_train, loss_val = avg_loss(model, train_set), avg_loss(model, val_set)\n    results = Dict(\n        :epoch => epoch,\n        :acc_train => acc_train,\n        :acc_val => acc_val,\n        :loss_train => loss_train,\n        :loss_val => loss_val\n    )\n    push!(log, results)\n\n    # Print progress:\n    results_df = DataFrame(log)\n    vals = Matrix(results_df[2:end,[:loss_train,:loss_val]])\n    plt = UnicodePlots.lineplot(1:epoch, vals; \n        name=[\"Train\",\"Validation\"], title=\"Loss in epoch $epoch\", xlim=(1,nepochs))\n    UnicodePlots.display(plt)\n\nend\n```\n:::\n\n\n@fig-mnist shows the training and validation loss and accuracy over epochs. The model is overfitting, as the validation loss increases after bottoming out at around epoch 20.\n\n::: {#00873a00 .cell execution_count=12}\n``` {.julia .cell-code}\noutput = DataFrame(log)\noutput = output[2:end,:]\n\nanim = @animate for epoch in 1:maximum(output.epoch)\n    p_loss = plot(output[1:epoch,:epoch], Matrix(output[1:epoch,[:loss_train,:loss_val]]), \n        label=[\"Train\" \"Validation\"], title=\"Loss\", legend=:topleft)\n    p_acc = plot(output[1:epoch,:epoch], Matrix(output[1:epoch,[:acc_train,:acc_val]]), \n        label=[\"Train\" \"Validation\"], title=\"Accuracy\", legend=:topleft)\n    plot(p_loss, p_acc, layout=(1,2), dpi=300, margin=5mm, size=(800,400))\nend\ngif(anim, joinpath(www_path, \"c4_mnist.gif\"), fps=5)\n```\n:::\n\n\n![Training and validation loss and accuracy](../www/c4_mnist.gif){#fig-mnist width=\"100%\"}\n\n",
    "supporting": [
      "c4_files"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js\" integrity=\"sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js\" integrity=\"sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==\" crossorigin=\"anonymous\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}